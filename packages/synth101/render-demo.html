<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synth101 WAV Renderer Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            margin-top: 0;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .controls {
            background: #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }
        
        .control-group label {
            min-width: 100px;
            font-weight: 500;
            color: #495057;
        }
        
        input, select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            flex: 1;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .progress {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        audio {
            width: 100%;
            margin: 15px 0;
            border-radius: 8px;
        }
        
        .sequence-info {
            background: #f1f3f4;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #6c757d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéπ Synth101 WAV Renderer</h1>
        <p class="subtitle">Render MIDI sequences to WAV using OfflineAudioContext and scheduleEvents</p>
        
        <div class="controls">
            <h3>‚öôÔ∏è Render Settings</h3>
            <div class="control-group">
                <label for="duration">Duration:</label>
                <input type="number" id="duration" value="10" min="1" max="60" step="0.5">
                <span>seconds</span>
            </div>
            <div class="control-group">
                <label for="sampleRate">Sample Rate:</label>
                <select id="sampleRate">
                    <option value="44100">44.1 kHz</option>
                    <option value="48000">48 kHz</option>
                    <option value="96000">96 kHz</option>
                </select>
            </div>
        </div>
        
        <div class="grid">
            <div class="card">
                <h3>üéº Musical Sequences</h3>
                <p>Choose a pre-made musical sequence to render:</p>
                <div class="preset-grid">
                    <button onclick="loadSequence('scale')">Scale</button>
                    <button onclick="loadSequence('chords')">Chords</button>
                    <button onclick="loadSequence('arpeggio')">Arpeggio</button>
                    <button onclick="loadSequence('demo')">Demo</button>
                </div>
                <div id="sequence-info" class="sequence-info" style="display: none;"></div>
            </div>
            
            <div class="card">
                <h3>üéõÔ∏è Synth Presets</h3>
                <p>Select a synthesizer sound preset:</p>
                <div class="preset-grid">
                    <button onclick="loadPreset('lead')">Lead</button>
                    <button onclick="loadPreset('pad')">Pad</button>
                    <button onclick="loadPreset('bass')">Bass</button>
                </div>
                <div id="preset-info"></div>
            </div>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <button id="renderButton" onclick="renderAudio()" style="padding: 15px 40px; font-size: 18px;">
                üöÄ Render WAV
            </button>
        </div>
        
        <div id="status" class="status info" style="display: none;"></div>
        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <audio id="audioPlayer" controls style="display: none;"></audio>
        
        <div class="footer">
            <p>üéµ Powered by Web Audio Modules (WAM) and Synth101</p>
            <p>Uses OfflineAudioContext for high-quality offline rendering</p>
        </div>
    </div>

    <script type="module">
        import { 
            renderSynth101ToWAV, 
            downloadWav, 
            exampleSequences, 
            exampleSynthSettings 
        } from './wav-renderer.js';

        let currentSequence = 'demo';
        let currentPreset = 'lead';
        let isRendering = false;

        // UI elements
        const status = document.getElementById('status');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const renderButton = document.getElementById('renderButton');
        const audioPlayer = document.getElementById('audioPlayer');
        const sequenceInfo = document.getElementById('sequence-info');
        const presetInfo = document.getElementById('preset-info');

        // Load sequence and update UI
        window.loadSequence = function(sequenceName) {
            currentSequence = sequenceName;
            const sequence = exampleSequences[sequenceName];
            
            // Update sequence info
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const info = sequence.map(([time, note, vel, dur], i) => {
                const noteName = noteNames[note % 12] + Math.floor(note / 12 - 1);
                return `${(i + 1).toString().padStart(2)}: ${time.toFixed(2)}s - ${noteName} (vel:${vel}, dur:${dur}s)`;
            }).join('\n');
            
            sequenceInfo.textContent = `Sequence "${sequenceName}":\n${info}`;
            sequenceInfo.style.display = 'block';
            
            showStatus(`Loaded "${sequenceName}" sequence (${sequence.length} notes)`, 'info');
        };

        // Load preset and update UI
        window.loadPreset = function(presetName) {
            currentPreset = presetName;
            const preset = exampleSynthSettings[presetName];
            
            // Update preset info
            const presetDesc = {
                lead: 'Square wave with bright filter and punchy envelope',
                pad: 'Sine wave with slow attack and long release',
                bass: 'Sawtooth wave in lower octave with tight envelope'
            };
            
            presetInfo.innerHTML = `<small style="color: #666; margin-top: 10px; display: block;">${presetDesc[presetName] || ''}</small>`;
            
            showStatus(`Selected "${presetName}" preset`, 'info');
        };

        // Render audio
        window.renderAudio = async function() {
            if (isRendering) return;
            
            isRendering = true;
            renderButton.disabled = true;
            renderButton.textContent = 'üîÑ Rendering...';
            
            try {
                showStatus('Initializing offline rendering...', 'info');
                showProgress(0);
                
                const duration = parseFloat(document.getElementById('duration').value);
                const sampleRate = parseInt(document.getElementById('sampleRate').value);
                const sequence = exampleSequences[currentSequence];
                const synthSettings = exampleSynthSettings[currentPreset];
                
                showProgress(20);
                showStatus('Loading WAM modules...', 'info');
                
                // Simulate progress updates
                const progressSteps = [40, 60, 80, 90];
                const messages = [
                    'Creating offline audio context...',
                    'Initializing Synth101...',
                    'Scheduling MIDI events...',
                    'Rendering audio...'
                ];
                
                for (let i = 0; i < progressSteps.length; i++) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                    showProgress(progressSteps[i]);
                    showStatus(messages[i], 'info');
                }
                
                // Actual rendering
                const audioBuffer = await renderSynth101ToWAV({
                    duration,
                    sampleRate,
                    sequence,
                    synthSettings
                });
                
                showProgress(100);
                showStatus('Rendering complete! Creating WAV file...', 'success');
                
                // Create audio element for playback
                const wavBuffer = audioBufferToWav(audioBuffer);
                const blob = new Blob([wavBuffer], { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(blob);
                
                audioPlayer.src = audioUrl;
                audioPlayer.style.display = 'block';
                
                // Auto-download
                const filename = `synth101_${currentSequence}_${currentPreset}.wav`;
                downloadWav(audioBuffer, filename);
                
                showStatus(`WAV file rendered and downloaded: ${filename}`, 'success');
                
            } catch (error) {
                console.error('Rendering failed:', error);
                showStatus(`Rendering failed: ${error.message}`, 'error');
            } finally {
                isRendering = false;
                renderButton.disabled = false;
                renderButton.textContent = 'üöÄ Render WAV';
                hideProgress();
            }
        };

        // Utility functions
        function showStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function showProgress(percent) {
            progressContainer.style.display = 'block';
            progressBar.style.width = percent + '%';
        }

        function hideProgress() {
            progressContainer.style.display = 'none';
        }

        // Convert AudioBuffer to WAV (copy from wav-renderer.js)
        function audioBufferToWav(buffer) {
            const length = buffer.length;
            const numberOfChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const bytesPerSample = 2;
            const blockAlign = numberOfChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = length * blockAlign;
            
            const arrayBuffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(arrayBuffer);
            
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numberOfChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, dataSize, true);
            
            let offset = 44;
            for (let i = 0; i < length; i++) {
                for (let ch = 0; ch < numberOfChannels; ch++) {
                    let sample = buffer.getChannelData(ch)[i];
                    sample = Math.max(-1, Math.min(1, sample));
                    const intSample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                    view.setInt16(offset, intSample, true);
                    offset += 2;
                }
            }
            
            return arrayBuffer;
        }

        // Initialize with defaults
        loadSequence('demo');
        loadPreset('lead');
        showStatus('Ready to render! Select a sequence and preset, then click "Render WAV"', 'info');
    </script>
</body>
</html>